<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Breakage from new trait impls - Standard library developers Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide for standard library developers">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../about-this-guide.html">About this guide</a></li><li class="chapter-item expanded affix "><a href="../../getting-started.html">Getting started</a></li><li class="chapter-item expanded affix "><a href="../../reviewer-checklist.html">Reviewer checklist</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../feature-lifecycle/summary.html"><strong aria-hidden="true">1.</strong> The feature lifecycle</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../feature-lifecycle/new-unstable-features.html"><strong aria-hidden="true">1.1.</strong> Landing new features</a></li><li class="chapter-item expanded "><a href="../../feature-lifecycle/tracking-issues.html"><strong aria-hidden="true">1.2.</strong> Using tracking issues</a></li><li class="chapter-item expanded "><a href="../../feature-lifecycle/stabilization.html"><strong aria-hidden="true">1.3.</strong> Stabilizing features</a></li><li class="chapter-item expanded "><a href="../../feature-lifecycle/deprecation.html"><strong aria-hidden="true">1.4.</strong> Deprecating features</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../code-considerations/summary.html"><strong aria-hidden="true">2.</strong> Code considerations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/design/summary.html"><strong aria-hidden="true">2.1.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/design/public-apis.html"><strong aria-hidden="true">2.1.1.</strong> Public APIs</a></li></ol></li><li class="chapter-item expanded "><a href="../../code-considerations/breaking-changes/summary.html"><strong aria-hidden="true">2.2.</strong> Breaking changes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/breaking-changes/behavior.html"><strong aria-hidden="true">2.2.1.</strong> Breakage from changing behavior</a></li><li class="chapter-item expanded "><a href="../../code-considerations/breaking-changes/new-trait-impls.html" class="active"><strong aria-hidden="true">2.2.2.</strong> Breakage from new trait impls</a></li><li class="chapter-item expanded "><a href="../../code-considerations/breaking-changes/fundamental.html"><strong aria-hidden="true">2.2.3.</strong> #[fundamental] types</a></li></ol></li><li class="chapter-item expanded "><a href="../../code-considerations/safety-and-soundness/summary.html"><strong aria-hidden="true">2.3.</strong> Safety and soundness</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/safety-and-soundness/generics-and-unsafe.html"><strong aria-hidden="true">2.3.1.</strong> Generics and unsafe</a></li><li class="chapter-item expanded "><a href="../../code-considerations/safety-and-soundness/may-dangle.html"><strong aria-hidden="true">2.3.2.</strong> Drop and #[may_dangle]</a></li><li class="chapter-item expanded "><a href="../../code-considerations/safety-and-soundness/mem-and-exclusive-refs.html"><strong aria-hidden="true">2.3.3.</strong> std::mem and exclusive references</a></li></ol></li><li class="chapter-item expanded "><a href="../../code-considerations/using-unstable-lang/summary.html"><strong aria-hidden="true">2.4.</strong> Using unstable language features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/using-unstable-lang/const-generics.html"><strong aria-hidden="true">2.4.1.</strong> Const generics</a></li><li class="chapter-item expanded "><a href="../../code-considerations/using-unstable-lang/specialization.html"><strong aria-hidden="true">2.4.2.</strong> Specialization</a></li></ol></li><li class="chapter-item expanded "><a href="../../code-considerations/performance/summary.html"><strong aria-hidden="true">2.5.</strong> Performance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../code-considerations/performance/inline.html"><strong aria-hidden="true">2.5.1.</strong> When to #[inline]</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../tools-and-bots/summary.html"><strong aria-hidden="true">3.</strong> Tools and bots</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../tools-and-bots/bors.html"><strong aria-hidden="true">3.1.</strong> @bors</a></li><li class="chapter-item expanded "><a href="../../tools-and-bots/timer.html"><strong aria-hidden="true">3.2.</strong> @rust-timer</a></li><li class="chapter-item expanded "><a href="../../tools-and-bots/crater.html"><strong aria-hidden="true">3.3.</strong> @craterbot</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Standard library developers Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/std-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#breakage-from-new-trait-impls" id="breakage-from-new-trait-impls">Breakage from new trait impls</a></h1>
<p>A lot of PRs to the standard library are adding new impls for already stable traits, which can break consumers in many weird and wonderful ways. The following sections gives some examples of breakage from new trait impls that may not be obvious just from the change made to the standard library.</p>
<p>Also see <a href="./fundamental.html"><code>#[fundamental]</code> types</a> for special considerations for types like <code>&amp;T</code>, <code>&amp;mut T</code>, <code>Box&lt;T&gt;</code>, and other core smart pointers.</p>
<h2><a class="header" href="#inference-breaks-when-a-second-generic-impl-is-introduced" id="inference-breaks-when-a-second-generic-impl-is-introduced">Inference breaks when a second generic impl is introduced</a></h2>
<p>Rust will use the fact that there's only a single impl for a generic trait during inference. This breaks once a second impl makes the type of that generic ambiguous. Say we have:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in `std`
impl From&lt;&amp;str&gt; for Arc&lt;str&gt; { .. }
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in an external `lib`
let b = Arc::from(&quot;a&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>then we add:</p>
<pre><code class="language-diff">impl From&lt;&amp;str&gt; for Arc&lt;str&gt; { .. }
+ impl From&lt;&amp;str&gt; for Arc&lt;String&gt; { .. }
</code></pre>
<p>then</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let b = Arc::from(&quot;a&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>will no longer compile, because we've previously been relying on inference to figure out the <code>T</code> in <code>Box&lt;T&gt;</code>.</p>
<p>This kind of breakage can be ok, but a [crater] run should estimate the scope.</p>
<h2><a class="header" href="#deref-coercion-breaks-when-a-new-impl-is-introduced" id="deref-coercion-breaks-when-a-new-impl-is-introduced">Deref coercion breaks when a new impl is introduced</a></h2>
<p>Rust will use deref coercion to find a valid trait impl if the arguments don't type check directly. This only seems to occur if there's a single impl so introducing a new one may break consumers relying on deref coercion. Say we have:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in `std`
impl Add&lt;&amp;str&gt; for String { .. }

impl Deref for String { type Target = str; .. }
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// in an external `lib`
let a = String::from(&quot;a&quot;);
let b = String::from(&quot;b&quot;);

let c = a + &amp;b;
<span class="boring">}
</span></code></pre></pre>
<p>then we add:</p>
<pre><code class="language-diff">impl Add&lt;&amp;str&gt; for String { .. }
+ impl Add&lt;char&gt; for String { .. }
</code></pre>
<p>then</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let c = a + &amp;b;
<span class="boring">}
</span></code></pre></pre>
<p>will no longer compile, because we won't attempt to use deref to coerce the <code>&amp;String</code> into <code>&amp;str</code>.</p>
<p>This kind of breakage can be ok, but a <a href="../../tools-and-bots/crater.html">crater</a> run should estimate the scope.</p>
<h2><a class="header" href="#for-reviewers" id="for-reviewers">For reviewers</a></h2>
<p>Look out for new <code>#[stable]</code> trait implementations for existing stable traits.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../code-considerations/breaking-changes/behavior.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../code-considerations/breaking-changes/fundamental.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../code-considerations/breaking-changes/behavior.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../code-considerations/breaking-changes/fundamental.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
